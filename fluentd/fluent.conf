<source>
  @type tail
  path /var/log/sample.log
  pos_file /fluentd/log/sample.pos
  tag sample.log
  format none
</source>

<filter sample.log>
  @type record_transformer
  <record>
    host "#{Socket.gethostname}"
    fluentd_worker $worker_id
  </record>
</filter>

<match sample.log>
  @type loki
  url http://loki:3100
  
  <label>
    host
    tag
    fluentd_worker
  </label>
  
  remove_keys fluentd_worker
  line_format json
  
#   <buffer>
#     @type memory
#     flush_mode interval 
#     flush_interval 150s  # Fixed typo ("60ss" → "60s")
#     flush_at_shutdown true
#     chunk_limit_size 1k  # Fixed unit ("kb" → "k")
#     queued_chunks_limit_size 64
#     total_limit_size 512MB
#     overflow_action block 
#     retry_type exponential_backoff
#     retry_timeout 24h
#     retry_max_interval 60s
#     retry_forever true
#   </buffer>
    # <buffer>
    #     @type memory
    #     total_limit_size 1m       # Force small buffer (1MB)
    #     chunk_limit_size 500k     # Large chunks to fill quickly
    #     queued_chunks_limit_size 2  # Very low queue limit
    #     overflow_action block  # Now throws errors
    # </buffer>
    <buffer>
        @type memory
        total_limit_size 512m      # Increase buffer size
        flush_interval 150s
        chunk_limit_size 1m        # Larger chunks
        queued_chunks_limit_size 64 # Higher queue limit
        overflow_action block      # Block instead of throwing exceptions
        retry_forever true         # Keep retrying
    </buffer>
</match>